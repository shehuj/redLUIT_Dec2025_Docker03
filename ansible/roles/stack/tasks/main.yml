---
- name: Copy stack file to manager
  copy:
    src: docker-stack.yml
    dest: /tmp/docker-stack.yml
    mode: '0644'
  when: inventory_hostname in groups['managers']

- name: Deploy stack on manager
  command: docker stack deploy --with-registry-auth -c /tmp/docker-stack.yml jenkinsstack
  become: true
  when: inventory_hostname in groups['managers']
  register: stack_deploy

- name: Wait for services to be ready
  pause:
    seconds: 10
  when: inventory_hostname in groups['managers']

- name: Get Jenkins initial admin password
  shell: docker exec $(docker ps -q -f name=jenkinsstack_jenkins) cat /var/jenkins_home/secrets/initialAdminPassword
  register: jenkins_password
  become: true
  ignore_errors: true
  when: inventory_hostname in groups['managers']

- name: Display service access URLs
  debug:
    msg:
      - "========================================="
      - "Stack 'jenkinsstack' deployed successfully!"
      - "========================================="
      - ""
      - "Access your services at:"
      - ""
      - "  Jenkins CI/CD Server:"
      - "    http://{{ hostvars[groups['managers'][0]].ansible_host }}:8081"
      - "    Initial Admin Password: {{ jenkins_password.stdout | default('Run: docker exec $(docker ps -q -f name=jenkinsstack_jenkins) cat /var/jenkins_home/secrets/initialAdminPassword') }}"
      - ""
      - "  Web Application (Nginx):"
      - "    http://{{ hostvars[groups['managers'][0]].ansible_host }}"
      - ""
      - "  Docker Swarm Visualizer:"
      - "    http://{{ hostvars[groups['managers'][0]].ansible_host }}:8080"
      - ""
      - "========================================="
      - "Useful Commands:"
      - "  docker service ls                    # List all services"
      - "  docker stack services jenkinsstack   # List stack services"
      - "  docker service logs jenkinsstack_jenkins  # View Jenkins logs"
      - "  docker service logs <service_name>   # View service logs"
      - "========================================="
  when: inventory_hostname in groups['managers']

